# PRD: 高级搜索系统

## 1. 概述

### 1.1 背景
当前搜索功能存在以下问题：
- 折叠指示器不明显
- 不支持多次查询历史保存
- 搜索面板与结果显示分离
- 缺少"在当前文件中查找"等专业功能

### 1.2 目标
参考 IntelliJ IDEA / Notepad++ 的查找功能，实现专业的多层级搜索结果管理系统。

### 1.3 设计决策 (已确认)

| 决策项 | 选择 |
|--------|------|
| 搜索弹窗类型 | **独立弹窗** (QDialog)，可拖动，非模态 |
| 结果面板位置 | **主窗口底部** |
| 多文件搜索 | **支持** "查找所有打开文件" |
| 搜索历史数量 | **10 条** |
| 回车键行为 | **查找下一个** |
| 实现优先级 | **弹窗 + 三级结构优先** |

---

## 2. 功能需求

### 2.1 搜索面板 (Search Panel)

**位置**: 独立弹窗，可拖动，不阻塞主窗口操作

**UI 组件**:
```
┌─────────────────────────────────────────────────────┐
│  查找目标: [____________________] [正则提示 ▼]      │
│                                                      │
│  ☐ 反向查找   ☐ 全词匹配   ☐ 匹配大小写            │
│  ☐ 循环查找                                         │
│                                                      │
│  查找模式: ○ 普通  ○ 扩展(\n,\r,\t,\0,...)         │
│            ○ 正则表达式行                           │
│                                                      │
│  [查找下一个(F3)] [查找上一个(F4)]                  │
│  [计数(C)]        [在当前文件中查找]                │
│  [清空结果]       [关闭]                            │
└─────────────────────────────────────────────────────┘
```

**按钮功能**:
| 按钮 | 快捷键 | 功能 |
|------|--------|------|
| 查找下一个 | F3 | 跳转到下一个匹配，高亮显示 |
| 查找上一个 | Shift+F3 / F4 | 跳转到上一个匹配 |
| 计数 | C | 统计当前文件中的匹配数量（仅显示数字，不保存结果） |
| 在当前文件中查找 | - | **核心功能**: 执行搜索并将结果保存到结果面板 |
| 清空结果 | - | 清空所有搜索历史 |

### 2.2 搜索结果面板 (Search Results Panel)

**位置**: 主窗口底部，可折叠/展开

**三级树形结构**:
```
▼ 🔍 "container-D-08" (3 个文件, 7558 个匹配)           [×]
    ▼ 📄 f2-2025-12-16-15-2.log (7558 个匹配)
        ├─ 行 19: ...s HighSearchResultPath: robot=container-D-08 reservePointName=AP585...
        ├─ 行 93: 2025-12-16 15:24:28.304 [TP2-23] INFO Fleet - Fleet/Traffic... (2 个匹配)
        │   ├─ [1] ...TP2|RobotPlanSolutionOk robot=container-D-08 solution=container-D-08|ok=tr...
        │   └─ [2] ...robot=container-D-08 solution=container-D-08|ok=true|cost=22.0|expandedCou...
        └─ 行 94: ...TP2|editPathIndexOffset robot=container-D-08 pathIndexOffset=15...
    ▼ 📄 another-log.log (120 个匹配)
        └─ ...

▼ 🔍 "HighSearchResultPath" (1 个文件, 234 个匹配)      [×]
    └─ 📄 f2-2025-12-16-15-2.log (234 个匹配)
        └─ ...
```

**层级说明**:
| 层级 | 内容 | 图标 | 数据 |
|------|------|------|------|
| L1 | 搜索词 | 🔍 | 查询关键词 + 总文件数 + 总匹配数 |
| L2 | 文件名 | 📄 | 文件名 + 该文件匹配数 |
| L3 | 匹配行 | (无) | 行号 + 上下文预览 |
| L4 | 同行多匹配 | [n] | 匹配序号 + 精确上下文 |

### 2.3 交互行为

**搜索触发逻辑**:
- `查找下一个/上一个`: 仅跳转高亮，**不保存**到结果面板
- `计数`: 仅显示统计数字，**不保存**到结果面板
- `在当前文件中查找`: **保存**到结果面板，创建/更新搜索词节点

**双击跳转**:
- 双击 L1 (搜索词): 无操作（仅展开/折叠）
- 双击 L2 (文件名): 切换到该文件标签页
- 双击 L3/L4 (匹配行): 跳转到精确位置并高亮

**右键菜单**:
- L1 节点: `删除此搜索` / `复制搜索词`
- L2 节点: `从结果中移除此文件`
- L3/L4 节点: `删除行` / `删除节` / `复制行内容`

**折叠/展开**:
- 点击展开图标 (▶/▼) 切换状态
- 新搜索结果默认展开到 L2 级别

---

## 3. 视觉设计

### 3.1 折叠指示器优化
```css
/* 当前问题：折叠指示器不明显 */
/* 解决方案：使用明显的三角形图标 */

QTreeWidget::branch:has-children:closed {
    image: url(:/icons/chevron-right.svg);  /* ▶ */
}
QTreeWidget::branch:has-children:open {
    image: url(:/icons/chevron-down.svg);   /* ▼ */
}

/* 或使用 Unicode 字符作为前缀 */
L1 前缀: "▶ 🔍" / "▼ 🔍"
L2 前缀: "  ▶ 📄" / "  ▼ 📄"
```

### 3.2 层级缩进
```
L1: 0px (搜索词)
L2: 20px (文件名)
L3: 40px (匹配行)
L4: 60px (同行子匹配)
```

### 3.3 颜色方案 (暗色主题)
| 元素 | 颜色 |
|------|------|
| L1 背景 | #1E3A5F (深蓝) |
| L1 文字 | #60A5FA (亮蓝) |
| L2 背景 | transparent |
| L2 文字 | #9CA3AF (灰) |
| L3/L4 背景 | transparent |
| L3/L4 文字 | #C9D1D9 (浅灰) |
| 匹配高亮 | #FFE66D (黄) on #000 |
| 选中行 | #1F6FEB (蓝) |
| 删除按钮 [×] | #EF4444 (红) hover |

---

## 4. 数据结构

```python
@dataclass
class SearchResult:
    """单次搜索结果"""
    search_id: str              # UUID
    query: str                  # 搜索词
    is_regex: bool              # 是否正则
    case_sensitive: bool        # 是否大小写敏感
    timestamp: datetime         # 搜索时间
    file_results: List[FileResult]  # 文件结果列表

@dataclass
class FileResult:
    """单个文件的搜索结果"""
    file_path: str              # 文件路径
    file_name: str              # 文件名
    tab_index: int              # 标签页索引
    matches: List[MatchResult]  # 匹配列表

@dataclass
class MatchResult:
    """单个匹配"""
    line_num: int               # 行号 (0-based)
    start_col: int              # 起始列
    end_col: int                # 结束列
    line_text: str              # 完整行内容
    context: str                # 上下文预览
```

---

## 5. 实现优先级

### Phase 1: 搜索弹窗重构
- [ ] 创建独立搜索弹窗 (QDialog)
- [ ] 实现基础按钮功能
- [ ] "查找下一个/上一个" 仅跳转不保存

### Phase 2: 三级树形结构
- [ ] 实现 L1 搜索词层级
- [ ] 实现 L2 文件层级
- [ ] 实现 L3/L4 匹配行层级
- [ ] 优化折叠指示器样式

### Phase 3: 多次搜索历史
- [ ] 支持保存多个搜索结果
- [ ] 每个搜索词可独立删除
- [ ] 搜索词去重（相同词更新而非新增）

### Phase 4: 交互完善
- [ ] 右键菜单
- [ ] 快捷键绑定
- [ ] 拖拽调整结果面板高度

---

## 6. 验收标准

1. ✅ 搜索弹窗独立于主窗口，可拖动
2. ✅ "查找下一个/上一个" 仅跳转，不污染结果面板
3. ✅ "在当前文件中查找" 将结果保存到三级树形结构
4. ✅ 折叠指示器清晰可见 (▶/▼)
5. ✅ 支持多次搜索，历史结果保留
6. ✅ 双击 L3/L4 节点精确跳转到匹配位置
7. ✅ 右键菜单支持删除搜索/删除行/删除节

---

## 7. 详细原型设计 (Detailed Prototype)

### 7.1 搜索弹窗设计 (Search Dialog)

**设计参考**: Notepad++ / IntelliJ IDEA
**类型**: 非模态窗口 (QDialog), 始终置顶, 可拖动

```text
┌──────────────────────────────────────────────────────────────┐
│  🔍 查找                                               [×] │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  查找目标(F): [ 输入搜索关键词或正则...                ] ▼   │
│                                                              │
│  ┌─ 选项 ──────────────────────────────────────────────────┐ │
│  │ ☐ 反向查找(B)    ☐ 全词匹配(W)     ☐ 匹配大小写(C)      │ │
│  │ ☑ 循环查找(R)                                           │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌─ 查找模式 ──────────────────────────────────────────────┐ │
│  │ ◎ 普通(N)   ○ 扩展(\\n, \\r, \\t...)(X)   ○ 正则表达式(E)  │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  [ 查找下一个(F3) ]   [ 查找上一个(Sh+F3) ]  [   计数(T)    ]│
│                                                              │
│  [ 在当前文件中查找 ] [ 查找所有打开文件 ]   [  清空结果    ]│
│                                                              │
│                                            [    关闭      ]  │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 7.2 结果面板设计 (Results Panel)

**设计参考**: IntelliJ IDEA "Find in Files"
**位置**: 主界面底部, 可调节高度, 可通过 Splitter 拖拽

```text
┌──────────────────────────────────────────────────────────────┐
│ 结果面板 [__________________] (Filter results)      [—][×] │
├──────────────────────────────────────────────────────────────┤
│ ▼ 🔍 "ERROR" (3 files, 15 matches)                           │
│ │                                                            │
│ ├── ▼ 📄 application.log (12 matches)                        │
│ │   │                                                        │
│ │   ├── 105: [ERROR] Connection refused...                   │
│ │   ├── 108: [ERROR] Timeout waiting for...                  │
│ │   │                                                        │
│ │   ├── 112: ...caused by [ERROR] Network unreachable...     │
│ │   │   ├── [1] ...caused by [ERROR] Network unreachable...  │
│ │   │   └── [2] ...[ERROR] Network unreachable (Retry 3)...  │
│ │   │                                                        │
│ │   └── 120: [ERROR] Transaction failed                      │
│ │                                                            │
│ ├── ▶ 📄 system.log (2 matches)                              │
│ │                                                            │
│ └── ▶ 📄 access.log (1 match)                                │
│                                                              │
│ ▶ 🔍 "Exception" (1 file, 5 matches)                         │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 7.3 交互状态 (Interaction States)

#### 节点状态
| 状态 | 视觉表现 | 触发条件 | 行为 |
|---|---|---|---|
| **Normal** | 背景透明, 文字默认色 | 默认 | - |
| **Hover** | 背景淡蓝色 (#1F6FEB22) | 鼠标悬停 | 显示行号/文件路径提示 |
| **Selected** | 背景深蓝色 (#1F6FEB), 文字白色 | 点击 | 在上方编辑器中跳转到对应位置 |
| **Focused** | 虚线边框 | 键盘导航 | `Enter`跳转, `Delete`删除 |

#### 展开/折叠
- **L1 (搜索词)**: 默认展开. 点击 `▼` 折叠, 隐藏该搜索的所有结果.
- **L2 (文件)**: 默认展开. 点击 `▼` 折叠, 隐藏该文件的匹配行.
- **L3 (多匹配行)**: 默认展开. 显示具体匹配位置的子节点.

### 7.4 边界情况处理 (Edge Cases)

| 场景 | 表现 | 处理方式 |
|---|---|---|
| **无搜索结果** | 弹窗状态栏显示 "未找到匹配项" (红色) | 结果面板不显示/不更新 |
| **搜索中** | 弹窗按钮变为不可用, 显示加载动画 | 防止重复提交, 允许 "取消" |
| **超大结果集** | (>10000 条) | 结果面板仅显示前 1000 条, 底部显示 "显示更多..." 按钮或分页 |
| **文件已关闭** | 结果面板中的文件节点变灰 | 点击时提示 "文件已关闭", 询问是否重新打开 |
| **搜索词过长** | L1 节点文本截断显示 "Very long search te..." | 悬停显示完整 Tooltip |

### 7.5 键盘快捷键映射 (Keyboard Shortcuts)

| 作用域 | 按键 | 功能 |
|---|---|---|
| **Global** | `Ctrl + F` | 打开搜索弹窗 |
| | `F3` | 查找下一个 (不打开弹窗) |
| | `Shift + F3` | 查找上一个 (不打开弹窗) |
| **Dialog** | `Enter` | 执行 "查找下一个" |
| | `Shift + Enter` | 执行 "查找上一个" |
| | `Alt + F` | 聚焦 "查找目标" 输入框 |
| | `Alt + C` | 触发 "计数" |
| | `Alt + A` | 触发 "在当前文件中查找" |
| | `Esc` | 关闭弹窗 |
| **Results** | `Enter` | 跳转到选中的匹配行 |
| | `Up / Down` | 上下选择节点 |
| | `Left` | 折叠节点 / 跳转到父节点 |
| | `Right` | 展开节点 / 跳转到第一个子节点 |
| | `Delete` | 从结果中移除选中项 (行/文件/搜索组) |